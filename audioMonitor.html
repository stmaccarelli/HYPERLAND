<!DOCTYPE html>
<html lang="en">
<head>
	<title>HYPERLAND SYSTEM MONITOR</title>
	<meta charset="utf-8">
	<meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, minimal-ui">
	<link href="css/style.css" rel="stylesheet" type="text/css">
</head>
<body width="100%" style="margin:20px;">
  <canvas id="canvas" style="margin:0 0 24px;"></canvas>
	<button id="peakReset" style="height:40px; font-size:30px;">RESET PEAKS</button>
	<button id="showUseful" style="height:40px; font-size:30px;" onclick="javascript:showUseful=!showUseful;">SHOW/HIDE USED FREQS</button>
<!--
	<div id="splash">
		<div id ="prompt">
			<div id="prompt-big">Collect the crystals <br> before the dawn comes!</div>
			<div id="prompt-small">Use arrow keys to move left or right.</div>
		</div>
	</div>
	<div id="debug-text"></div>
	<div id="score-text">0</div>
	<div id="container"></div>
	<div id="music-toggle"></div>
	<div id="preloader"></div>

	<div id="info">Built with Love by <a href='http://www.airtight.cc'>Airtight</a>. Try it on Mobile!</div> -->

  <!--
  A BIG thanks to airtight.cc for the WebGL / THREE.JS tutorials
  The main landscape motion logic is based on Winter Rush game logic developed by airtight.cc
  -->
	<!-- Utils Libs -->
  <script src="lib/NoSleep.min.js"></script>
  <script src="lib/NoScroll.js"></script>

	<!-- NODE SOCKET.IO -->
	<script src="http://pixelsmasher.io:1502/socket.io/socket.io.js" type="text/javascript"></script>

	<!-- DEV audio lib -->
	<script src="lib/dev/AudioAnalyzerDev.js"></script>

	<script type="text/javascript">
	window.addEventListener('load',init, true);

	function init(){
		var socket = io('http://pixelsmasher.io:1502');

		// TODO: webworker per emit messaggi FFT
		function fakeAudioAnalysis(){
			window.setTimeout(function(){ window.requestAnimationFrame(fakeAudioAnalysis)}, 1000/20);
			socket.emit('mxr_push_fft',{
				a:AA.getFreq(0),
				b:AA.getFreq(1),
				c:AA.getFreq(12),
				d:AA.getFreq(32),
				e:AA.getFreq(64)
			});
		}


		//	AA.getFreqArray
		// window.addEventListener("AAload",fakeAudioAnalysis);
		 window.addEventListener("AAload",function(){
		//	window.setInterval(fakeAudioAnalysis,1000/30);
		fakeAudioAnalysis();
		});

		window.addEventListener('keyup',emit_keystroke,true);
		function emit_keystroke(e){
			socket.emit('mxr_push_key',{a:e.keyCode});
		}

		socket.on('mobi_count',function(e){console.log(e)});

	}
	</script>

  <script type="text/javascript">
    var canvas = document.getElementById("canvas");
		var resScale = 0.5;
    canvas.width = document.body.clientWidth*resScale;
		canvas.style.width = document.body.clientWidth+"px";
		canvas.style.imageRendering = 'pixelated';
		canvas.style.imageRendering += '-webkit-crisp-edges';
		canvas.style.imageRendering += '-moz-crisp-edges';
    var c = canvas.getContext("2d");
    var totalFreqs = AA.getFreqArray.length;
    var barWidth = canvas.width/totalFreqs-resScale;
    var barHeight = canvas.width * 0.25;
		canvas.height = barHeight;

    var freq;//temp freq to draw
    var peak = [];
		var useful;
		var showUseful = true;
		var REDUCEPEAKS = false;

    function update(){
      // c.clearRect(0,0,c.width,c.height);
      c.fillStyle = "rgb(50,50,50)";
      c.fillRect (0, 0, canvas.width, barHeight);

			//DRAW BARS
      for(var i in AA.getFreqArray){
        freq = AA.getFreq(i);
				if(showUseful) useful = (i==0 || i==1 || i==12 || i==32 || i==64)?50:15;
				else useful = 50;

					c.fillRect (i*(barWidth+resScale), barHeight, barWidth, -barWidth);
        c.fillStyle = "hsl("+(256-freq*256)+",100%,"+useful+"%)";
        c.fillRect (i*(barWidth+resScale), barHeight, barWidth, -freq*barHeight);

				c.fillStyle = "hsl("+(256-peak[i]*256)+",100%,"+(peak[i]>.99?100:useful)+"%)";
				//draw peaks
				c.fillRect (i*(barWidth+resScale), barHeight-peak[i]*barHeight, barWidth, barWidth);
        if(AA.getFreq(i)>peak[i] || peak[i]===undefined) peak[i] = AA.getFreq(i);
				if(REDUCEPEAKS)
				 for(var i in peak)
					 peak[i]-=0.00001;
      }

			// //DRAW PEAKS
      // for(var i in AA.getFreqArray){
      //   c.fillStyle = "hsl("+(256-peak[i]*256)+",100%,"+(peak[i]>.99?100:50)+"%)";
      //   c.fillRect (i*(barWidth+resScale), barHeight-peak[i]*barHeight, barWidth, barWidth);
      //   if(AA.getFreq(i)>peak[i] || peak[i]===undefined) peak[i] = AA.getFreq(i);
			//
			// 	if(REDUCEPEAKS)
      //    for(var i in peak)
      //      peak[i]-=0.00001;
      // }

      //draw a middle level line
      c.fillStyle="rgb(255,255,255)";
      c.fillRect(0,barHeight*.5,canvas.width,2);

			//draw a 3/4 level line
			c.fillStyle="rgb(255,255,255)";
			c.fillRect(0,barHeight*.25,canvas.width,2);

			//call rAF
      window.requestAnimationFrame(update);
    };
      window.addEventListener("AAload",function(){
        update();
      },false);

			window.addEventListener('resize',function(){
				canvas.width = window.innerWidth;
				barWidth = canvas.width/totalFreqs-1;
			},false);

			document.getElementById('peakReset').addEventListener('click',function(){ peak=[]; },false);
  </script>

</body>
</html>
